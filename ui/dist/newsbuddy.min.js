window.news_buddy=angular.module("NewsBuddy",["ngRoute","ngSanitize","infinite-scroll","typeahead.directives"]).config(["$routeProvider","$locationProvider",function(a,b){b.hashPrefix("!").html5Mode(!1),a.when("/latest",{templateUrl:"partials/search_results.html",controller:"SearchController"}).when("/stats",{templateUrl:"partials/stats.html",controller:"StatsController"}).when("/detail/:resultId",{templateUrl:"partials/details.html",controller:"DetailsController"}).otherwise({redirectTo:"/latest"})}]),angular.module("NewsBuddy").controller("SearchController",["$scope","$http","$location",function(a,b,c){a.query=null,a.clearSearch=function(){a.offset=0,a.results={},(void 0==a.old_query||a.old_query!=a.query)&&(a.search_filters={}),a.old_query=a.query,a.results_array=[],a.sources=null,a.publish_dates=null,a.all_loaded=!1},a.search=function(){a.query&&($("#no-results").show(),a.clearSearch(),a.loadPage())},a.loadLatestNews=function(){a.loading=!0,b.get("/v1/news/latest/").success(function c(c){a.loading=!1,a.all_loaded=!0,d(c.results)})},a.loadPage=function(){if(!a.loading){a.loading=!0;var e="/v1/news/query/?offset="+a.offset+"&q="+a.query;for(var f in a.search_filters)a.search_filters.hasOwnProperty(f)&&(e+="&"+f+"="+encodeURIComponent(a.search_filters[f]));c.hash(a.query),b.get(e).success(function h(h){return c.hash(a.query),h.results?(d(h.results),g(h.facets),a.loading=!1,a.offset+=h.results.length,a.offset>=h.total&&(a.all_loaded=!0),void 0):(a.loading=!1,void 0)})}},a.filter=function(b,c){a.clearSearch(),null===c?delete a.search_filters[b]:("published"===b&&"Prej"===c&&(c="before"),a.search_filters[b]=c),a.loadPage()},a.processSuggestions=function(a){return a.suggestions};var d=function(b){h(b);for(var c=0;c<b.length;c++){var d=f(b[c].published);d in a.results||(a.results[d]=[]),a.results[d].push(b[c])}for(var d in a.results){var g=$.grep(a.results_array,function(a){return a.published===d});if(0==g.length)a.results_array.push({published:d,articles:a.results[d]});else{for(var i=g[0].articles.slice(),c=0;c<a.results[d].length;c++){var j=a.results[d][c];e(i,j.id)||i.push(j)}g[0].articles=i}}},e=function(a,b){for(var c=0;c<a.length;c++)if(a[c].id===b)return!0;return!1},f=function(a){var b=new Date(Date.parse(a));return b.setUTCHours(0),b.setUTCMinutes(0),b.setUTCSeconds(0),b.setUTCMilliseconds(0),b.toISOString()},g=function(b){if(null!=b.source){var c=b.source;c.sort(function(a,b){return b[1]-a[1]}),a.sources=c}if(null!=b.published){var d=b.published;if(d.sort(function(a,b){return a[0]>b[0]?-1:a[0]<b[0]?1:0}),d.length>0&&"before"==d[0][0]){d[0][0]="Prej";var e=d.shift();d.push(e)}a.publish_dates=d}},h=function(a){a.sort(function(a,b){return a.published<b.published?1:a.published>b.published?-1:0})};a.clearSearch(),a.$on("newsbuddy:autocomplete:selected",function(){a.search(),a.$digest()}),c.hash()?(a.query=c.hash(),a.search()):a.loadLatestNews()}]),google.load("visualization","1",{packages:["corechart"]}),angular.module("NewsBuddy").controller("StatsController",["$scope","$http",function(a,b){a.stats={total_news:0,news_today:0},b.get("/v1/news/stats/").success(function c(c){a.stats=c;var b=c.total_by_source,d=c.total_by_source_today,e=c.news_by_day,f=new google.visualization.DataTable;f.addColumn("date","Dan"),f.addColumn("number","Stevilo");var g=[];for(var h in e)e.hasOwnProperty(h)&&g.push(h);g.sort();for(var i=0;i<g.length;i++){var h=g[i],j=new Date(Date.parse(h));f.addRow([j,e[h]])}var k=[null],l=[null];for(var h in b)b.hasOwnProperty(h)&&(k.push(h),l.push(b[h]));var m=[null],n=[null];for(var h in d)b.hasOwnProperty(h)&&(m.push(h),n.push(d[h]));var l=google.visualization.arrayToDataTable([k,l]),n=google.visualization.arrayToDataTable([m,n]),o={hAxis:{title:"Novic"},tooltip:{showColorCode:!0},backgroundColor:"#f9f9f9"},p=new google.visualization.AreaChart(document.getElementById("news-by-day"));p.draw(f,{"legend.position":"none",isStacked:!0,backgroundColor:"#f9f9f9"});var q=new google.visualization.BarChart(document.getElementById("news-by-source"));q.draw(l,o);var r=new google.visualization.BarChart(document.getElementById("news-by-source-today"));r.draw(n,o)})}]),angular.module("NewsBuddy").controller("DetailsController",["$scope","$routeParams","$http",function(a,b,c){a.loading=!0;var d="/v1/news/detail/?id="+b.resultId,e="/v1/news/related/?id="+b.resultId;c.get(d).success(function f(f){a.news_item=f,console.info(f)}),c.get(e).success(function g(g){a.loading=!1,a.related_news=g.results})}]);